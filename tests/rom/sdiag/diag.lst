       1                                ;
       2                                ; simple rom monitor
       3                                ;
       4 007000                         STACK = 7000
       5 006000                         LINBUF = 6000
       6                                ;ORG = 2000
       7 173000                         ORG = 173000	
       8                                
       9                                	.TITLE rom
      10                                	.ASECT
      11                                	.ENABL AMA
      12 173000                         	.=ORG
      13                                
      14                                start:
      15 173000 000240                  	nop
      16 173002 012706  007000          	mov	#STACK,sp
      17 173006 004737  174114          	jsr	pc,init
      18 173012 000137  173022          	jmp	loop
      19                                
      20 173016 000000                  stop1:	halt
      21 173020 000000                  stop2:	halt
      22                                
      23                                loop:
      24 173022 004737  173724          	jsr	pc,prompt
      25 173026 004737  173762          	jsr	pc,getcmd
      26 173032 012705  006000          	mov	#LINBUF,r5
      27                                
      28 173036 122715  000162          	cmpb	#'r,@r5
      29 173042 001521                  	beq	cread
      30 173044 122715  000150          	cmpb	#'h,@r5
      31 173050 001421                  	beq	cquit
      32 173052 122715  000144          	cmpb	#'d,@r5
      33 173056 001417                  	beq	cdump
      34 173060 122715  000145          	cmpb	#'e,@r5
      35 173064 001447                  	beq	cexam
      36 173066 122715  000147          	cmpb	#'g,@r5
      37 173072 001474                  	beq	cgo
      38 173074 122715  000151          	cmpb	#'i,@r5
      39 173100 001532                  	beq	cide
      40 173102 122715  000170          	cmpb	#'x,@r5
      41 173106 001565                  	beq	creset
      42                                
      43 173110 000137  173022          	jmp	loop
      44                                
      45                                ;
      46                                cquit:
      47 173114 000000                  	halt
      48                                
      49                                ;
      50                                cdump:
      51 173116 004737  173736          	jsr	pc,crlf
      52                                
      53 173122 062705  000002          	add	#2,r5
      54 173126 010501                  	mov	r5,r1
      55 173130 004737  173510          	jsr	pc,getaddr
      56 173134 010004                  	mov	r0,r4
      57                                
      58 173136 010401                  	mov	r4,r1
      59 173140 004737  173560          	jsr	pc,dword
      60 173144 112701  000072          	movb	#':,r1
      61 173150 004737  174234          	jsr	pc,putc
      62 173154 004737  173750          	jsr	pc,space
      63                                
      64                                ; jsr	pc,crlf
      65                                ; jmp	loop
      66                                
      67 173160 012702  000010          	mov	#10,r2
      68                                cdmp1:
      69 173164 012401                  	mov	(r4)+,r1
      70 173166 004737  173546          	jsr	pc,dwordsp
      71 173172 077204                  	sob	r2,cdmp1
      72 173174 004737  173736          	jsr	pc,crlf
      73                                
      74 173200 000137  173022          	jmp	loop
      75                                
      76                                ;
      77                                cexam:
      78 173204 004737  173736          	jsr	pc,crlf
      79                                
      80 173210 062705  000002          	add	#2,r5
      81 173214 010501                  	mov	r5,r1
      82 173216 004737  173510          	jsr	pc,getaddr
      83 173222 010004                  	mov	r0,r4
      84                                
      85 173224 010401                  	mov	r4,r1
      86 173226 004737  173560          	jsr	pc,dword
      87 173232 112701  000072          	movb	#':,r1
      88 173236 004737  174234          	jsr	pc,putc
      89 173242 004737  173750          	jsr	pc,space
      90                                
      91 173246 012401                  	mov	(r4)+,r1
      92 173250 004737  173546          	jsr	pc,dwordsp
      93 173254 004737  173736          	jsr	pc,crlf
      94                                
      95 173260 000137  173022          	jmp	loop
      96                                
      97                                ;
      98                                cgo:
      99 173264 004737  173736          	jsr	pc,crlf
     100                                
     101 173270 062705  000002          	add	#2,r5
     102 173274 010501                  	mov	r5,r1
     103 173276 004737  173510          	jsr	pc,getaddr
     104 173302 010004                  	mov	r0,r4
     105                                
     106 173304 000104                  	jmp	r4
     107                                
     108                                ; ---------------------------------------------------------------------------
     109                                
     110 177412                         rkda = 177412
     111                                
     112                                cread:
     113 173306 012700  000000          	mov	#0,r0    ; unit number
     114 173312 010003                  	mov	r0,r3
     115 173314 000303                  	swab	r3
     116 173316 006303                  	asl	r3
     117 173320 006303                  	asl	r3
     118 173322 006303                  	asl	r3
     119 173324 006303                  	asl	r3
     120 173326 006303                  	asl	r3
     121                                
     122 173330 012701  177412          	mov	#rkda, r1	; csr
     123 173334 010311                  	mov	r3,(r1)		; load da
     124 173336 005041                  	clr	-(r1)		; clear ba
     125                                	
     126 173340 012741  177000          	mov	#-256.*2,-(r1)	; load wc
     127                                	
     128 173344 012741  000005          	mov	#5,-(r1)	; read & go
     129                                	
     130 173350 105711                  	tstb	(r1)
     131 173352 100376                  	bpl	.-2
     132 173354 105011                  	clrb	(r1)
     133                                
     134 173356 004737  173736          	jsr	pc,crlf
     135 173362 000137  173022          	jmp	loop
     136                                
     137                                ; ---------------------------------------------------------------------------
     138                                
     139                                
     140 177404                         rkcmd  = 177404
     141                                
     142 177414                         idereg = 177414
     143 177416                         idedat = 177416
     144                                
     145                                cide:
     146 173366 012702  000020          	mov	#20,r2
     147 173372 012705  000010          	mov	#10,r5
     148 173376 004737  173736          	jsr	pc,crlf
     149                                cide1:
     150 173402 010201                  	mov	r2,r1
     151 173404 004737  173560          	jsr	pc,dword
     152 173410 004737  173750          	jsr	pc,space	; regnum + dpace
     153                                
     154 173414 012704  177414          	mov	#idereg,r4
     155 173420 010224                  	mov	r2,(r4)+
     156                                
     157 173422 012703  177404          	mov	#rkcmd,r3
     158 173426 012713  000013          	mov	#13,(r3)	; read ide (rchk) & go
     159                                	
     160 173432 105713                  	tstb	(r3)
     161 173434 100376                  	bpl	.-2
     162 173436 105013                  	clrb	(r3)
     163                                
     164 173440 011401                  	mov	(r4),r1
     165 173442 004737  173560          	jsr	pc,dword	; get reg value
     166                                
     167 173446 004737  173736          	jsr	pc,crlf
     168 173452 005202                  	inc	r2
     169 173454 077526                  	sob	r5,cide1
     170                                
     171 173456 000137  173022          	jmp	loop
     172                                
     173                                creset:
     174 173462 012703  177404          	mov	#rkcmd,r3
     175 173466 012713  000001          	mov	#1,(r3)		; controller reset & go
     176 173472 000240                  	nop
     177 173474 000240                  	nop
     178 173476 105013                  	clrb	(r3)
     179                                
     180 173500 004737  173736          	jsr	pc,crlf
     181 173504 000137  173022          	jmp	loop
     182                                
     183                                ; ---------------------------------------------------------------------------
     184                                
     185                                ; parse octal address in r5
     186                                ; return in r0
     187                                getaddr:
     188 173510 010246                  	mov	r2,-(sp)
     189 173512 005002                  	clr	r2
     190                                getad2:
     191 173514 112501                  	movb	(r5)+,r1
     192 173516 001410                  	beq	getad3
     193 173520 042701  177770          	bic	#177770,r1
     194 173524 006302                  	asl	r2
     195 173526 006302                  	asl	r2
     196 173530 006302                  	asl	r2
     197 173532 050102                  	bis	r1,r2
     198 173534 000137  173514          	jmp	getad2
     199                                getad3:
     200 173540 010200                  	mov	r2,r0
     201 173542 012602                  	mov	(sp)+,r2
     202 173544 000207                  	rts	pc
     203                                
     204                                ;
     205                                dwordsp:
     206 173546 004737  173560          	jsr	pc,dword
     207 173552 004737  173750          	jsr	pc,space
     208 173556 000207                  	rts	pc
     209                                
     210                                ;
     211                                ; print word in r1
     212                                ;
     213                                dword:
     214 173560 010246                  	mov	r2,-(sp)
     215 173562 010346                  	mov	r3,-(sp)
     216                                
     217 173564 012703  010000          	mov	#dbuf,r3
     218                                
     219 173570 004737  173672          	jsr	pc,dig1
     220 173574 004737  173672          	jsr	pc,dig1
     221 173600 004737  173672          	jsr	pc,dig1
     222 173604 004737  173672          	jsr	pc,dig1
     223 173610 004737  173672          	jsr	pc,dig1
     224 173614 004737  173672          	jsr	pc,dig1
     225                                
     226 173620 114301                  	movb	-(r3),r1
     227 173622 004737  174234          	jsr	pc,putc
     228 173626 114301                  	movb	-(r3),r1
     229 173630 004737  174234          	jsr	pc,putc
     230 173634 114301                  	movb	-(r3),r1
     231 173636 004737  174234          	jsr	pc,putc
     232 173642 114301                  	movb	-(r3),r1
     233 173644 004737  174234          	jsr	pc,putc
     234 173650 114301                  	movb	-(r3),r1
     235 173652 004737  174234          	jsr	pc,putc
     236 173656 114301                  	movb	-(r3),r1
     237 173660 004737  174234          	jsr	pc,putc
     238                                
     239 173664 012603                  	mov	(sp)+,r3
     240 173666 012602                  	mov	(sp)+,r2
     241 173670 000207                  	rts	pc
     242                                
     243                                ; add one digit to output
     244                                dig1:
     245 173672 010102                  	mov	r1,r2
     246 173674 042702  177770          	bic	#177770,r2
     247 173700 062702  000060          	add	#'0,r2
     248 173704 110223                  	movb	r2,(r3)+
     249                                
     250 173706 042701  000007          	bic	#7,r1
     251 173712 000241                  	clc
     252 173714 006001                  	ror	r1
     253 173716 006001                  	ror	r1
     254 173720 006001                  	ror	r1
     255 173722 000207                  	rts	pc
     256                                
     257                                ;
     258                                prompt:
     259 173724 012700  174305          	mov	#msg2,r0
     260 173730 004737  174220          	jsr	pc,pmsg
     261 173734 000207                  	rts	pc
     262                                
     263                                crlf:
     264 173736 012700  174302          	mov	#msgcr,r0
     265 173742 004737  174220          	jsr	pc,pmsg
     266 173746 000207                  	rts	pc
     267                                
     268                                space:
     269 173750 112701  000040          	movb	#' ,r1
     270 173754 004737  174234          	jsr	pc,putc
     271 173760 000207                  	rts	pc
     272                                
     273                                ;
     274                                getcmd:
     275 173762 012705  006000          	mov	#LINBUF,r5
     276                                getcm1:
     277 173766 004737  174250          	jsr	pc,getc
     278 173772 022701  000015          	cmp	#15,r1		; cr?
     279 173776 001410                  	beq	getcm2
     280 174000 022701  000177          	cmp	#177,r1		; rubout?
     281 174004 001412                  	beq	getcm3
     282 174006 004737  174234          	jsr	pc,putc
     283 174012 110125                  	movb	r1,(r5)+
     284 174014 000137  173766          	jmp	getcm1
     285                                getcm2:
     286 174020 112725  000000          	movb	#0,(r5)+	; term w/zero
     287 174024 112725  000000          	movb	#0,(r5)+	; term w/zero
     288 174030 000207                  	rts	pc
     289                                
     290                                getcm3:
     291 174032 022705  006000          	cmp	#LINBUF,r5	; don't backspace past beginning
     292 174036 001420                  	beq	getcm4
     293 174040 162705  000001          	sub	#1,r5		; backup ptr
     294 174044 012701  000010          	mov	#10,r1
     295 174050 004737  174234          	jsr	pc,putc
     296 174054 012701  000040          	mov	#40,r1
     297 174060 004737  174234          	jsr	pc,putc
     298 174064 012701  000010          	mov	#10,r1
     299 174070 004737  174234          	jsr	pc,putc
     300 174074 000137  173766          	jmp	getcm1	
     301                                getcm4:
     302 174100 012701  000007          	mov	#7,r1		; beep
     303 174104 004737  174234          	jsr	pc,putc
     304 174110 000137  173766          	jmp	getcm1	
     305                                
     306                                ;
     307                                init:
     308 174114 000240                  	nop
     309                                
     310 174116 005000                  	clr	r0
     311 174120 012701  001234          	mov	#1234,r1
     312 174124 010110                  	mov	r1,(r0)		; write 0
     313                                
     314 174126 012700  002000          	mov	#2000,r0
     315 174132 012701  004321          	mov	#4321,r1
     316 174136 010110                  	mov	r1,(r0)		; write 2000
     317                                
     318 174140 000240                  	nop
     319 174142 005000                  	clr	r0
     320 174144 011002                  	mov	(r0),r2		; read 0
     321 174146 012701  001234          	mov	#1234,r1
     322 174152 020102                  	cmp	r1,r2
     323 174154 001015                  	bne	bad1
     324                                
     325 174156 000240                  	nop
     326 174160 012700  002000          	mov	#2000,r0
     327 174164 011002                  	mov	(r0),r2		; read 2000
     328 174166 012701  004321          	mov	#4321,r1
     329 174172 020102                  	cmp	r1,r2
     330 174174 001007                  	bne	bad2
     331                                
     332 174176 012700  174264          	mov	#msg1,r0
     333 174202 004737  174220          	jsr	pc,pmsg
     334 174206 000207                  	rts	pc
     335                                
     336 174210 000137  173016          bad1:	jmp	stop1
     337 174214 000137  173020          bad2:	jmp	stop2
     338                                
     339                                ;
     340                                ;
     341                                ;
     342                                pmsg:
     343 174220 112001                  	movb	(r0)+,r1
     344 174222 001403                  	beq	pmsg1
     345 174224 004737  174234          	jsr	pc,putc
     346 174230 000773                  	br	pmsg
     347                                pmsg1:
     348 174232 000207                  	rts	pc
     349                                
     350                                
     351                                ;
     352                                ;
     353                                ;
     354                                
     355 177560                         kbs = 177560
     356 177562                         kbb = 177562
     357                                
     358 177564                         tps = 177564
     359 177566                         tpb = 177566
     360                                
     361                                ; print char in r1
     362                                putc:
     363 174234 105737  177564          	tstb	tps
     364 174240 100375                  	bpl	putc
     365 174242 110137  177566          	movb	r1,tpb
     366 174246 000207                  	rts	pc
     367                                
     368                                ; return char in r1
     369                                getc:
     370 174250 105737  177560          	tstb	kbs
     371 174254 100375                  	bpl	getc
     372 174256 113701  177562          	movb	kbb,r1
     373 174262 000207                  	rts	pc
     374                                
     375                                ; -------------------------------------------------------------------------
     376                                
     377                                	.even
     378                                
     379                                msg1:
     380 174264    015     012          	.byte	15,12
     381 174266    110     145     154  	.ascii "Hello world!"
         174271    154     157     040  
         174274    167     157     162  
         174277    154     144     041  
     382                                msgcr:
     383 174302    015     012          	.byte	15,12
     384 174304    000                  	.byte	0
     385                                
     386                                msg2:
     387 174305    015     012          	.byte	15,12
     388 174307    162     157     155  	.ascii "rom> "
         174312    076     040          
     389 174314    000                  	.byte	0
     390                                
     391 010000                         	.=10000
     392                                dbuf:
     393 010000    000     000     000  	.byte	0,0,0,0,0,0
         010003    000     000     000  
     394                                
     395                                	.even
     396                                
     397                                
     397                                
